# Development Dockerfile - includes build tools for live development
# Supports PostgreSQL 11+
# Use this when you want to mount source code and rebuild on the fly

ARG PG_VERSION=14
FROM postgres:${PG_VERSION}

# Get PostgreSQL major version
RUN PG_MAJOR=$(pg_config --version | sed -E 's/PostgreSQL ([0-9]+)\..*/\1/') && \
    echo "Building for PostgreSQL ${PG_MAJOR}" && \
    echo ${PG_MAJOR} > /tmp/pg_major_version

# Install build dependencies
RUN PG_MAJOR=$(cat /tmp/pg_major_version) && \
    apt-get update && \
    apt-get install -y \
        build-essential \
        postgresql-server-dev-${PG_MAJOR} \
        make \
        gcc \
        libc6-dev \
        && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    rm /tmp/pg_major_version

# Set working directory
WORKDIR /usr/src/extension

# PostgreSQL environment variables must be provided via docker-compose or .env file
# Required: POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB

# Expose PostgreSQL port
EXPOSE 5432

# Create a script that builds and installs the extension
RUN echo '#!/bin/bash\n\
set -e\n\
cd /usr/src/extension\n\
if [ -f Makefile ]; then\n\
    echo "Building extension..."\n\
    make clean || true\n\
    make\n\
    make install\n\
    echo "Extension built and installed successfully!"\n\
else\n\
    echo "Warning: Makefile not found. Source code should be mounted at /usr/src/extension"\n\
fi\n\
exec docker-entrypoint.sh postgres "$@"' > /usr/local/bin/build-and-run.sh && \
    chmod +x /usr/local/bin/build-and-run.sh

# Override entrypoint to build extension before starting PostgreSQL
ENTRYPOINT ["/usr/local/bin/build-and-run.sh"]
CMD ["postgres"]
