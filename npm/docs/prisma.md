# Using Ethiopian Calendar with Prisma

## Quick Setup

```bash
# Install the package
npm install @huluwz/pg-ethiopian-calendar

# Generate migration
npx ethiopian-calendar init prisma

# Apply migration
npx prisma migrate dev
```

## Manual Setup

If you prefer to set up manually:

### 1. Create Migration Folder

```bash
mkdir -p prisma/migrations/20240101000000_ethiopian_calendar
```

### 2. Copy SQL File

Copy the SQL from `node_modules/@huluwz/pg-ethiopian-calendar/sql/ethiopian_calendar.sql` to `prisma/migrations/20240101000000_ethiopian_calendar/migration.sql`

### 3. Apply Migration

```bash
npx prisma migrate dev
```

## Usage Examples

### Generated Columns

Create a table with automatically calculated Ethiopian dates:

```sql
-- In your migration file
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    customer_name TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    created_at_ethiopian TIMESTAMP GENERATED ALWAYS AS 
        (to_ethiopian_timestamp(created_at)) STORED
);
```

### Prisma Schema

```prisma
model Order {
  id                   Int       @id @default(autoincrement())
  customerName         String    @map("customer_name")
  createdAt            DateTime  @default(now()) @map("created_at")
  createdAtEthiopian   DateTime  @map("created_at_ethiopian")

  @@map("orders")
}
```

**Note:** `createdAtEthiopian` is read-only (generated by database). Don't include it in `create` or `update` operations.

### Using in Code

```typescript
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

// Create - Ethiopian date is auto-generated
const order = await prisma.order.create({
  data: {
    customerName: 'Abebe Kebede',
  }
})

console.log(order.createdAtEthiopian) // Ethiopian timestamp!

// Raw query
const today = await prisma.$queryRaw`
  SELECT current_ethiopian_date() as today
`
```

### Functional Index

```sql
CREATE INDEX idx_orders_ethiopian 
ON orders (to_ethiopian_date(created_at));
```

## Available Functions

| Function | Description |
|----------|-------------|
| `to_ethiopian_date(timestamp)` | Convert to Ethiopian date string (YYYY-MM-DD) |
| `from_ethiopian_date(text)` | Convert Ethiopian date to Gregorian timestamp |
| `to_ethiopian_timestamp(timestamp)` | Convert preserving time (for generated columns) |
| `current_ethiopian_date()` | Get current Ethiopian date |

## Troubleshooting

### Migration Already Exists

If you get an error about the migration already existing:

```bash
npx prisma migrate resolve --applied 20240101000000_ethiopian_calendar
```

### Functions Not Found

Make sure the migration was applied:

```bash
npx prisma migrate status
```

## Links

- [GitHub Repository](https://github.com/HuluWZ/pg-ethiopian-calendar)
- [NPM Package](https://www.npmjs.com/package/@huluwz/pg-ethiopian-calendar)

