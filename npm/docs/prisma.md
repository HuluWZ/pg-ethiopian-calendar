# Using Ethiopian Calendar with Prisma

## Quick Setup

```bash
# Install the package
npm install @huluwz/pg-ethiopian-calendar

# Generate migration for ethiopian calendar functions
npx ethiopian-calendar init prisma

# Apply migration
npx prisma migrate deploy
```

## Prisma Schema

```prisma
model Order {
  id                 Int       @id @default(autoincrement())
  customerName       String    @map("customer_name")
  createdAt          DateTime  @default(now()) @map("created_at")
  createdAtEthiopian DateTime? @map("created_at_ethiopian")  // Generated column

  @@map("orders")
}
```

**Note:** `createdAtEthiopian` must be optional (`DateTime?`) since Prisma only reads it—PostgreSQL generates it.

## ⚠️ Important: Migration Workflow for Generated Columns

Prisma doesn't natively support PostgreSQL `GENERATED ALWAYS AS` columns. When adding tables with Ethiopian date columns, **do not run `prisma migrate dev` directly**.

### The Problem

```bash
# ❌ DON'T do this - Prisma will generate wrong SQL
npx prisma migrate dev
```

Prisma sees `createdAtEthiopian DateTime?` and creates a regular nullable column, not a generated one.

### The Solution

```bash
# ✅ Step 1: Create empty migration
npx prisma migrate dev --create-only --name add_orders_table
```

```bash
# ✅ Step 2: Edit the generated migration.sql manually
```

Replace Prisma's generated SQL with:

```sql
CREATE TABLE "orders" (
    "id" SERIAL PRIMARY KEY,
    "customer_name" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "created_at_ethiopian" TIMESTAMP(3) GENERATED ALWAYS AS 
        (to_ethiopian_timestamp(created_at)) STORED
);
```

```bash
# ✅ Step 3: Apply the migration
npx prisma migrate deploy
```

## Generated Column Types

### Timestamp (Recommended)

Preserves full date and time:

```sql
"created_at_ethiopian" TIMESTAMP(3) GENERATED ALWAYS AS 
    (to_ethiopian_timestamp(created_at)) STORED
```

```prisma
createdAtEthiopian DateTime? @map("created_at_ethiopian")
```

Result: `2018-04-26T12:30:00.000Z`

### Text/String

Date-only format:

```sql
"created_at_ethiopian" VARCHAR(10) GENERATED ALWAYS AS 
    (to_ethiopian_date(created_at)) STORED
```

```prisma
createdAtEthiopian String? @map("created_at_ethiopian") @db.VarChar(10)
```

Result: `"2018-04-26"`

## Usage in Code

```typescript
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

// Create - Ethiopian date is auto-generated by PostgreSQL
const order = await prisma.order.create({
  data: {
    customerName: 'Abebe Kebede',
  }
})

console.log(order.createdAt)          // 2026-01-04T12:30:00.000Z (Gregorian)
console.log(order.createdAtEthiopian) // 2018-04-26T12:30:00.000Z (Ethiopian)

// Raw queries for calendar utilities
const today = await prisma.$queryRaw`SELECT to_ethiopian_date()`
const converted = await prisma.$queryRaw`SELECT from_ethiopian_date('2018-04-26')`
```

## Functional Index

For fast queries by Ethiopian date:

```sql
CREATE INDEX idx_orders_ethiopian 
ON orders (to_ethiopian_date(created_at));
```

## Available Functions

| Function | Description |
|----------|-------------|
| `to_ethiopian_date()` | Current Ethiopian date as text |
| `to_ethiopian_date(timestamp)` | Convert to Ethiopian date string (YYYY-MM-DD) |
| `from_ethiopian_date(text)` | Convert Ethiopian date to Gregorian timestamp |
| `to_ethiopian_timestamp()` | Current Ethiopian timestamp |
| `to_ethiopian_timestamp(timestamp)` | Convert preserving time (for generated columns) |
| `ethiopian_calendar_version()` | Package version |

## Troubleshooting

### Migration Already Exists

```bash
npx prisma migrate resolve --applied 20240101000000_ethiopian_calendar
```

### Functions Not Found

Check migration status:

```bash
npx prisma migrate status
```

### Prisma Tries to "Fix" Generated Columns

If Prisma shows a migration to alter your generated columns, cancel it. The schema is correct—Prisma just doesn't understand generated columns.

## Links

- [GitHub Repository](https://github.com/HuluWZ/pg-ethiopian-calendar)
- [NPM Package](https://www.npmjs.com/package/@huluwz/pg-ethiopian-calendar)
